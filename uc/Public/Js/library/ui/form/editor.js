BQ.add("ui.form.Editor",function(s){function r(t,l){function w(){for(var b="00,33,66,99,cc,ff".split(","),a=[],c=0,i=[],n=[],g=[],f=0;f<6;f++)for(var j=0;j<6;j++)for(var e=0;e<6;e++){var k="#"+b[j]+b[e]+b[f];a.push('<td unselectable="on" style="background-color:'+k+'" select_color="'+k+'">&nbsp;</td>');if(c>0&&(c+1)%18==0)i.push("<tr>"+a.join("")+"</tr>"),a.length=0;c++}f=0;for(j=i.length;f<j;f++)f%2?g.push(i[f]):n.push(i[f]);return'<table border="1" cellspacing="0" cellpadding="0">'+n.join("")+g.join("")+
"</table>"}function m(b,a){return a?arguments.callee(a).getElementsByTagName(b):typeof b=="string"?document.getElementById(b):b}function u(b){this.guid=+new Date;this.textarea=this.get(b);this.textarea.style.display="none";this.box=document.createElement("DIV");this.box2=document.createElement("DIV");this.box.className="editor_box";this.box.id="editor_box_"+this.guid;this.box.innerHTML=x.replace(/\{\$guid\}/g,this.guid);this.textarea.parentNode.insertBefore(this.box,this.textarea);this.textarea.parentNode.insertBefore(this.box2,
this.textarea);this.box2.innerHTML=y.replace(/\{\$guid\}/g,this.guid);m("colorPanel_"+this.guid).innerHTML=w();this.index.apply(this,arguments);this.onblur=function(){}}if(!(this instanceof r))return new r(t,s.merge(z,l));l=this.config=l;document.getElementsByTagName("script");var p=s.Config.base+"ui/form/editor/img/emo",k=[];jQuery.each(l.compt,function(b,a){a=="select"&&k.push('<li class="select" menu="font-size"><a href="javascript:" title="\u5b57\u53f7"></a></li>');a=="font_color"&&k.push('<li class="font_color" menu="font-color"><a href="javascript:"></a></li>');
a=="font_b"&&k.push('<li class="font_b"><a href="javascript:"></a></li>');a=="align_l"&&k.push('<li class="align_l"><a href="javascript:"></a></li>');a=="align_c"&&k.push('<li class="align_c"><a href="javascript:"></a></li>');a=="align_r"&&k.push('<li class="align_r"><a href="javascript:"></a></li>');a=="setpic"&&k.push('<li class="setpic" menu="add-pic"><a href="javascript:"></a></li>');a=="setface"&&k.push('<li class="setface" menu="add-face"><a href="javascript:"></a></li>');a=="setlink"&&k.push('<li class="setlink" menu="add-link"><a href="javascript:"></a></li>')});
var x='<div class="editor_shell">        <div class="editor_tools">            <ul id="editor_tools_{$guid}">'+k.join("")+'            </ul>        </div>        <div class="editor_area">              <iframe name="" src="" allowTransparency="true" frameborder="0"></iframe>            <div class="ex_editor" id="editor_resize_{$guid}"></div>            <div class="resize_mask" id="resize_mask_{$guid}"></div>        </div>    </div>',y='<div class="editor_menu" id="menu_size_{$guid}">    <ul>        <li><a href="javascript:" style=""><font size="1">\u516d\u53f7</font></a></li>        <li><a href="javascript:" style=""><font size="2">\u4e94\u53f7</font></a></li>        <li><a href="javascript:" style=""><font size="3">\u56db\u53f7</font></a></li>        <li><a href="javascript:" style=""><font size="4">\u4e09\u53f7</font></a></li>        <li><a href="javascript:" style=""><font size="5">\u4e8c\u53f7</font></a></li>        <li><a href="javascript:" style=""><font size="6">\u4e00\u53f7</font></a></li>    </ul></div><div class="editor_menu" id="menu_kind_{$guid}">    <ul>        <li><a href="javascript:;" onclick="return false;"><font face="\u5b8b\u4f53">\u5b8b\u4f53</font></a></li>        <li><a href="javascript:;" onclick="return false;"><font face="\u9ed1\u4f53">\u9ed1\u4f53</font></a></li>        <li><a href="javascript:;" onclick="return false;"><font face="\u6977\u4f53_GB2312">\u6977\u4f53_GB2312</font></a></li>        <li><a href="javascript:;" onclick="return false;"><font face="\u65b0\u5b8b\u4f53">\u65b0\u5b8b\u4f53</font></a></li>        <li><a href="javascript:;" onclick="return false;"><font face="\u4eff\u5b8b_GB2312">\u4eff\u5b8b_GB2312</font></a></li>    </ul></div><div class="editor_menu colorPanel" id="colorPanel_{$guid}"></div><div class="editor_menu linkPanel" id="linkPanel_{$guid}">    URL\u5730\u5740: <input type="text" value="http://" /><span class="btn">\u6dfb\u52a0</span></div><div class="editor_menu linkPanel facePanel" id="facePanel_{$guid}">    </div><div class="editor_menu linkPanel" id="picPanel_{$guid}">    <div class="editor_img_tab"><a  class="selected">\u7f51\u7edc\u56fe\u7247</a><a >\u672c\u5730\u4e0a\u4f20</a></div>    <div id="tab1" class="tabs"><input type="text" value="http://" /><span class="btn">\u6dfb\u52a0</span></div>    <div id="tab2" class="tabs" style="display:none;width:262px;height:100px;"><h5 class="tabTitle">\u8bf7\u9009\u62e9\u56fe\u7247</h5><input id="img_input" type="text" value=""  style="float:left;display:inline;margin-right:5px;width:180px;"   readonly="readonly" /><div  style="width:60px;height:22px;float:left"><span id="btn_upload_l" class="swfupload_l btn">\u672c\u5730\u4e0a\u4f20</span></div><br/><br/><span class="btn_simple">\u786e\u5b9a</span><span class="btn_simple" id="btn_simple_l" >\u4e0a\u4f20\u56fe\u7247</span><div id="div_img_stu" style="float:left;display:inline;margin-right:5px;width:180px;">\u6682\u65e0\u56fe\u7247\uff01</div></div></div>',
A={font_b:["Bold"],font_i:["italic"],font_u:["UnderLine"],align_l:["JustifyLeft"],align_c:["JustifyCenter"],align_r:["JustifyRight"]},q;u.prototype={menus:{},isIE:!!window.attachEvent,index:function(b,a){this.tools=m("editor_tools_"+this.guid);this._activeFrame(a);this._initDefaultTools()},get:function(){return m.apply(null,arguments)},on:function(b,a,c){b.attachEvent?b.attachEvent("on"+a,function(){c.call(b,window.event)}):b.addEventListener(a,c,!1)},_initDefaultTools:function(){function b(b){var g;
g=A[this.className];if(a.isIE)a.range=a.doc.selection.createRange();if(g)a._setFont.apply(a,g);else if(g=this.getAttribute("menu"))if(g=a.menus[g])a.showMenu(b||window.event,this,g),g.getElementsByTagName("input").length&&setTimeout(function(){},10)}var a=this;this.each(m("li",this.tools),function(a){var g=a.getElementsByTagName("a");if(g.length)a.unselectable=g[0].unselectable=!0,this.on(a,"click",b)},this);a.on(document,"click",function(){a.hideAllMenu()});var c=m("iframe",a.box)[0],i=m("resize_mask_"+
this.guid);a.on(m("editor_resize_"+this.guid),"mousedown",function(b){var g=b.clientY,f=c.offsetHeight;i.style.display="block";document.onmousemove=function(b){b=b||window.event;c.style.height=Math.max(100,f+(b.clientY-g))+"px";i.style.height=i.parentNode.offsetHeight+"px";a.endUp(b)};document.onmouseup=function(){document.onmousemove=null;i.style.display="none"}})},gulu:function(){var b=this,a=navigator.userAgent.toLowerCase(),c=a.indexOf("msie")>-1&&a.indexOf("opera")==-1,i=a.indexOf("gecko")>-1&&
a.indexOf("khtml")==-1,n=a.indexOf("applewebkit")>-1;a.indexOf("opera");/(?:msie|firefox|webkit|opera)[\/:\s](\d+)/.exec(a);(function(a){function f(a,b){a.removeAllRanges();a.addRange(b)}function j(a){return a=a.replace(/<[^>]+>/ig,function(a){/<(\/?div)[^>]*>|<(\/?br)[^>]*>|<(\/?p)[^>]*>|<(\/?a )[^>]*>|<(\/a)>/ig.test(a)?(a=a.replace(/(<\/?div)[^>]*(>)/ig,"$1$2"),a=a.replace(/(<\/?p)[^>]*(>)/ig,"$1$2"),a=a.replace(/(<\/?a) .*?(href\s*?=\s*?["'].*?["'])[^>]*(>)/ig,"$1 $2 $3")):a=/(<\/.+?>)/ig.test(a)?
"</span>":"<span>";return a})}var e=m("iframe",b.box)[0].contentWindow;if(c){var k=e.document.selection.createRange(),h=window.clipboardData.getData("Text"),h=/\n|\n\r/ig.test(h)?"<p>"+h.replace(/\n\r|\n/ig,"</p>\n<p>")+"</p>":h.replace(/\n|\n\r/ig,"<br />"),h=j(h);k.pasteHTML(h);if(a){if(a.returnValue)a.returnValue=!1;a.preventDefault&&a.preventDefault()}return!1}else if(i){var d=e.document.createElement("div");d.id="htmleditor_tempdiv";d.innerHTML="\ufeff";d.style.left="-10000px";d.style.height=
"1px";d.style.width="1px";d.style.position="absolute";d.style.overflow="hidden";e.document.body.appendChild(d);var o=e.getSelection?e.getSelection():e.document.selection,l=o.getRangeAt(0),a=d.firstChild;rng=e.document.createRange();rng.setStart(a,0);rng.setEnd(a,1);f(o,rng);window.setTimeout(function(){d.innerHTML==="\ufeff"?h="":(h=d.innerHTML,h=j(h),d.innerHTML=h,f(o,l),e.document.execCommand("inserthtml",!1,h));e.document.body.removeChild(d)},0)}else if(n)d=e.document.createElement("div"),d.id=
"htmleditor_tempdiv",d.innerHTML="\ufeff",d.style.left="-10000px",d.style.height="1px",d.style.width="1px",d.style.position="absolute",d.style.overflow="hidden",e.document.body.appendChild(d),o=e.getSelection?e.getSelection():e.document.selection,l=o.getRangeAt(0),a=d.firstChild,rng=e.document.createRange(),rng.setStart(a,0),rng.setEnd(a,1),f(o,rng),window.setTimeout(function(){d.innerHTML==="\ufeff"?h="":(h=d.innerHTML,h=j(h),d.innerHTML=h,f(o,l),e.document.execCommand("inserthtml",!1,h));e.document.body.removeChild(d)},
0)})()},_activeFrame:function(b){var a=this;this.win=jQuery("iframe",this.box)[0];var c=this.win.contentWindow.document||this.win.contentDocument;c.open();c.write("<html><head><style>html,body{overflow-y:auto;font: 10pt verdana;margin:0;background:#fff;height:100%}p{margin:0px;padding:0px;}</style></head><body><p>"+(b||"&nbsp;")+"</p></body></html>");c.close();c.designMode="On";c.contentEditable=!0;this.doc=c;this.doc.onclick=function(){a.hideAllMenu()};if(this.isIE)c.onbeforedeactivate=function(){try{q=
c.selection.createRange().getBookmark()}catch(a){}},c.onactivate=function(){if(q){var a=c.body.createTextRange();a.moveToBookmark(q);a.select();q=null}};this.range=null;this.isIE&&jQuery(c).bind("click mousedown keydown",function(){a.range=c.selection.createRange()});jQuery(this.win.contentWindow.document).bind("paste",function(b){a.gulu(b)});this.on(this.win.contentWindow,"blur",function(b){a.textarea.value=a.doc.body.innerHTML;a.onblur(b,a.textarea.value)});this.on(this.win.contentWindow,"focus",
function(){a.hideAllMenu()})},counts:function(b){var a=this.doc;jQuery(this.doc).keyup(function(){var c=0,c=jQuery(a.body).text().length;jQuery(b).html(c);return c});jQuery(this.doc).mouseup(function(){var c=0,c=jQuery(a.body).text().length;jQuery(b).html(c);return c})},_setFont:function(b,a){this.isShowText||(window.focus(),this.win.focus(),this.doc.execCommand(b,!1,a||null))},_createLink:function(b){var a;this.hideAllMenu();this.isIE?(a=this.range,a.execCommand("CreateLink",!1,b),a.parentElement().target=
"_blank "):(this.doc.execCommand("CreateLink",!1,b),this.rang=this.doc.getSelection().getRangeAt(0),this.rang.commonAncestorContainer.parentNode.target="_blank ")},_insertImage:function(b){this.hideAllMenu();this.win.contentWindow.focus();if(this.isIE){var a=this.doc.selection.createRange();a.execCommand("InsertImage",!1,b);a.collapse(!0);a.select()}else this.doc.execCommand("InsertImage",!1,b)},getXY:function(b){var a=jQuery("#"+this.box.id).offset();return[a.left+b.offsetLeft,a.top+18]},showMenu:function(b,
a,c){var i=this.getXY(a),c=c.style;this.hideAllMenu();this.endUp(b);this.sender=a;c.display="block";c.left=i[0]-(this.isIE?1:-1)+"px";c.top=i[1]+a.offsetHeight-(this.isIE?4:1)+"px"},endUp:function(b){if(!b.stopPropagation)b.target=b.srcElement,b.stopPropagation=function(){b.cancelBubble=!0},b.preventDefault=function(){b.returnValue=!1};b.stopPropagation();b.preventDefault()},hideAllMenu:function(){for(var b in this.menus)m(this.menus[b]).style.display="none"},each:function(b,a,c){for(var i=b.length,
n=[],g=0;g<i;g++)if(n.push(b[g]),a&&!1===a.call(c||this,b[g],g))break;return n},addMenu:function(b,a){var c=this;if(typeof b!="string"){for(var i in b)this.addMenu(i,b[i]);return this}this.menus[b]=a.body;a.init&&a.init.call(this,a);this.each(a.body.getElementsByTagName(a.tag||"a"),function(b,g){this.on(b,"click",function(b){try{a.click.call(this,b,c,g)}catch(i){}})},this);return this},getValue:function(){return this.textarea.value=this.doc.body.innerHTML},setValue:function(b,a){try{a?this.textarea.value=
this.doc.body.innerHTML=b:this.isIE?(this.range.collapse(!1),this.range.pasteHTML(b),this.range.select()):this.doc.execCommand("inserthtml",!1,b)}catch(c){}}};var v=function(b,a,c){a=function(a){var b={amp:"&",lt:"<",gt:">",quot:'"',"#39":"'","#64":"@","#123":"{","#125":"}","#37":"%"},a=a.replace(/%/g,"&#37;");return decodeURIComponent(a).replace(/&([^;]+);/g,function(a,c){return b[c]||function(){if(c.charAt(0)=="#"){var b=Number("0"+c.substr(1));if(!isNaN(b))return String.fromCharCode(b)}return a}()})}(a);
b=new u(b,a);b.addMenu({"font-size":{body:b.get("menu_size_"+b.guid),click:function(a,b,c){b._setFont("FontSize",c+1);b.get("span",b.sender)[0].innerHTML=this.innerHTML}},"font-family":{body:b.get("menu_kind_"+b.guid),click:function(a,b){b._setFont("FontName",b.get("font",this)[0].getAttribute("face"));b.get("span",b.sender)[0].innerHTML=this.innerHTML}},"font-color":{body:b.get("colorPanel_"+b.guid),click:function(a,b){b.sender.getAttribute("menu")=="font-color"&&b._setFont("ForeColor",this.getAttribute("select_color"))},
tag:"td"},"font-bg":{body:b.get("colorPanel_"+b.guid),click:function(a,b){b.sender.getAttribute("menu")=="font-bg"&&b._setFont(/Firefox|Opera/i.test(navigator.userAgent)?"hilitecolor":"BackColor",this.getAttribute("select_color"))},tag:"td"},"add-link":{body:b.get("linkPanel_"+b.guid),init:function(a){function b(){if(/^http\:\/\/[^.]*$/i.test(f.value))return alert("\u65e0\u6548\u7684\u94fe\u63a5\uff01"),f.select();else if(c.isIE&&(c.range.text+"").length==0||(!c.isIE&&c.win.contentWindow.getSelection()+
"").length==0){alert("\u6ca1\u6709\u9009\u4e2d\u505a\u4e3a\u94fe\u63a5\u7684\u6587\u672c\uff01");return}c._createLink(f.value);f.value="http://"}var c=this,f=a.body.getElementsByTagName("input")[0],j=a.body.getElementsByTagName("span")[0];a.body.unselectable=j.unselectable=!0;this.on(a.body,"click",function(a){c.endUp(a)});this.on(f,"keyup",function(a){a.keyCode==13&&b()});this.on(j,"click",b)}},"add-pic":{body:b.get("picPanel_"+b.guid),init:function(a){function b(){if(!/\.(jpg|jpeg|gif|bmp|png)(\s|\?|$)/i.test(j.value))return alert("\u65e0\u6548\u7684\u56fe\u7247\u5730\u5740\uff01"),
j.select();f._insertImage(j.value);j.value="http://"}function c(){if(!/\.(jpg|jpeg|gif|bmp|png)(\s|\?|$)/i.test(e.value))return alert("\u65e0\u6548\u7684\u56fe\u7247\u5730\u5740\uff01"),e.select();f._insertImage(e.value);e.value="http://";jQuery("#div_img_stu").html("\u6682\u65e0\u56fe\u7247\uff01")}var f=this,j=a.body.getElementsByTagName("input")[0],e=a.body.getElementsByTagName("input")[1],k=a.body.getElementsByTagName("span")[0],h=a.body.getElementsByTagName("span")[2];a.body.unselectable=k.unselectable=
!0;a.body.unselectable=h.unselectable=!0;this.on(a.body,"click",function(a){f.endUp(a)});this.on(j,"keyup",function(a){a.keyCode==13&&b()});this.on(e,"keyup",function(a){a.keyCode==13&&c()});this.on(k,"click",b);this.on(h,"click",c);var d=jQuery("#picPanel_"+this.guid);d.find(".editor_img_tab a").click(function(){d.find(".tabs").hide().eq(jQuery(this).index()).show()})}},"add-face":{body:b.get("facePanel_"+b.guid),init:function(a){for(var a=a.body,b=[],c=1;c<41;c++)c<10?b.push('<img  class="'+c+'" src="'+
p+"/0"+c+'.gif"></img>'):b.push('<img  class="'+c+'" src="'+p+"/"+c+'.gif"></img>');a.innerHTML=b.join("")},click:function(a,b){this.className<10?b._insertImage(p+"/0"+this.className+".gif"):b._insertImage(p+"/"+this.className+".gif")},tag:"img"}});(c||function(){})();return b}(t,l.value);this.getValue=function(){return v.getValue()};this.setValue=function(b,a){return v.setValue(unescape(b),a)}}var z={value:"",compt:["select","font_color","font_b","align_l","align_c","align_r","setpic","setface",
"setlink"],canblack:""};return r});
