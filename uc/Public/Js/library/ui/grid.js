BQ.add("ui.Grid",function(s){function A(c,a){function h(k,a){var b=$("#style_"+q);b.length||(b=$('<style id="style_'+q+'" type="text/css"></style>').appendTo("head"));var c=b.html();$.browser.msie?b.get(0).styleSheet.cssText=c.match(a)?c.replace(a,k):c+(" "+k):b.html(c.match(a)?c.replace(a,k):c+(" "+k))}function m(){var k=[];$(f.Head,e).children(":not(:hidden)").each(function(){k.push($(this).outerWidth());K=$(this).outerHeight()});return k}function i(k){var a=[];$.each(k,function(b,c){for(var e=
0,f=0;f<b;f++)e+=k[f];a.push(c/2+e)});return a}function u(k){var a=[];$.each(k,function(b){for(var c=0,e=0;e<=b;e++)c+=k[e];a.push(c)});return a}var d=this,a=s.merge(Q,a);if(!(d instanceof A))return new A(c,a);String.prototype.reTrim=function(){return this.replace(/^#/,"")};var b=a.gridElement,f={Head:b.Head?b.Head:"div.grid_tit",viewContainer:b.viewContainer?b.viewContainer:".grid_data_wrap",View:b.View?b.View:"div.grid_data_wrap div.grid_data_item",dataCenter:b.dataCenter?b.dataCenter:".grid_center",
captionColumn:b.captionColumn?b.captionColumn:"div.grid_col",caption:b.caption?b.caption:"div.grid_caption",Title:b.Title?b.Title:"div.grid_tit_head"},b=a.Templete,n={view:b.view?b.view:'<div id="#id#" class="grid_wrap"><div class="grid_caption">#txt#</div><div class="grid_tit_back"><div class="grid_tit_head"></div></div><div class="grid_center"></div></div>',viewContainerTitle:'<div class="grid_tit pos">#col#</div>',viewContainer:b.viewContainer?b.viewContainer:'<div class="grid_data_wrap load"><i></i><img alt="" src="'+
BQ.Config.base+'/ui/static/loading.gif" /></div>',viewRow:b.viewRow?b.viewRow:'<div class="grid_data_item">#row#</div>',viewCell:b.viewCell?b.viewCell:'<span class="grid_col #cls#">#cell#</span>',viewTitle:b.viewTitle?b.viewTitle:'<div class="grid_col grid_col_click #cls#" field="#field#">#txt#<i class="grid_menu_px"></i></div>',drayLine:b.drayLine?b.drayLine:'<div id="#id#" class="drag none"></div>',layerTip:b.layerTip?b.layerTip:'<div id="#id#" class="layerTip none"><i></i><span></span></div>',
Arrow:b.Arrow?b.Arrow:['<i id="#id#" class="img_arrow_top none"></i>','<i id="#id#" class="img_arrow_bottom none"></i>'],Page:'<div id="#id#" class="grid_page"><span class="other">\u5171 <i></i> \u6761\u6570\u636e</span><span class="first_gray"></span><span class="prev_gray"></span><span class="separator"></span><span class="input"><input type="text" value="1" /> / <i>1000</i></span><span class="separator"></span><span class="next"></span><span class="last"></span><span class="separator"></span><span class="reload"></span><span class="separator"></span><span class="visible"></span></div>'};
d.config=a;d.container=c;d.caption=[];d.ele=f;d.temp=n;var p=a.DataSource.caption,q=c.match(/\w+/g)[0]||"",e="#grid_"+q,l="#drag_"+q,v="#Tip_"+q,w="#img_Top_"+q,B="#img_Bottom_"+q;d.autoGrid=e;$(c).html(n.view.replace("#id#",e.reTrim()).replace("#txt#",a.tabName));var H="";a.firstCheckbox&&(H='<div class="grid_col grid_col_click"><input type="checkbox" /></div>');$.each(p,function(k,a){d.caption.push(a.name);H+=n.viewTitle.replace("#txt#",a.text).replace("#field#",a.name).replace("#cls#","r"+k)});
$(f.Title,e).append(n.viewContainerTitle.replace("#col#",H));$(f.dataCenter,e).append(n.viewContainer);var x=$(f.dataCenter,e),C=$(e).offset();$(e).innerWidth();b=$(e).innerHeight();$(f.Title,e).scrollLeft(0);$.each(p,function(a,b){b.width&&h(".r"+a+"{width:"+b.width+"px}",RegExp(".r"+a+"{[^}]+}"))});a.firstCheckbox&&$(f.Title,e).find(f.captionColumn).first().find("input").click(function(){var a=this;$(this).parents(e).find(f.View).each(function(){$(this).children(":first").find("input").attr("checked",
a.checked)})});(d.updateTabWidth=function(){var a=$(c).css("width","auto").innerWidth();$(e).width(a-2).children(f.dataCenter+","+f.caption).width(a);$(f.Title,e).width(a);var b=0;$(f.Head).children(":not(:hidden)").each(function(){b+=$(this).outerWidth()});b=b<a?a-1:b;$(f.dataCenter,e).children().width(b);$(f.Title,e).children().width(b);x[0].scrollHeight>x.innerHeight()?$(f.Title,c).width($(c).innerWidth()-17):$(f.Title,c).width($(c).innerWidth())})();$(window).bind({resize:function(){d.updateTabWidth()}});
$(f.dataCenter,e).scroll(function(){$(".grid_tit.pos",e).css({overflow:"hidden",width:$(f.Title,e).width(),"word-wrap":"normal"}).scrollLeft(this.scrollLeft);$(f.Title,e).scrollLeft(this.scrollLeft)});$(e).has(l).length||$(e).append(n.drayLine.replace("#id#",l.reTrim()));p=$(e).find(f.caption);p=p.filter(":hidden").length?0:p.height();$(l).css({height:b,top:p});var L=0,M=0,I="",D=function(){return!1},N=function(){$(l).removeData("isDrag");$("body").css("cursor","auto");$(window.document).unbind("mouseup",
N);$(window.document).unbind("mousemove",O);$(window.document).unbind("selectstart",D);$(l).data("isDrag")||$(l).hide();y=!1;d.updateTabWidth()},O=function(a){if($(l).data("isDrag")){y=!0;var a=a.pageX-C.left,b=M+(a-L)-11+x.scrollLeft(),b="."+I+"{width:"+b+"px}",c=RegExp("."+I+"{[^}]+}");$(l).css("left",a).show();h(b,c)}};$(l).bind({mousedown:function(){$(this).data("isDrag",!0);$("body").css("cursor","col-resize");$(window.document).bind({selectstart:D,mouseup:N,mousemove:O})},mouseleave:function(){$(l).data("isDrag")||
$(l).hide()}});var J=!1,E=arr_Right=arr_Middle=[],z=null,r=0,o=0,K=0,y=!1,P=function(){J=!1;if(y){$(v).stop(!0,!0).hide();$(w).add($(B)).hide();if(r!=o&&o!=r-1){var a=$(f.Head,e).children(":not(:hidden)");a.eq(r).insertAfter(a.eq(o<0?0:o));$(f.View,e).each(function(){if(r!=o&&o!=r-1){var a=$(this).children(":not(:hidden)");a.eq(r).insertAfter(a.eq(o<0?0:o))}})}y=!1}$(window.document).unbind("mouseup",P);$(window.document).unbind("selectstart",D)};$(window.document).mousemove(function(b){if(a.firstCheckbox&&
$(b.target).index()==0)return!1;b.target!=$(l).get(0)&&!$(l).filter(":hidden").length&&!y&&$(l).hide();if(J)y=!0,$(v).length||$(document.body).append(n.layerTip.replace("#id#",v.reTrim())),$(v).find("span").text($(z).text()).end().css({left:b.clientX+10,top:b.clientY+10}).fadeIn("fast"),$.each(E,function(a){var c=b.clientX-C.left+x.scrollLeft();c>arr_Middle[a]&&c<arr_Right[a]&&($(w).length||($(document.body).append(n.Arrow[0].replace("#id#",w.reTrim())),$(document.body).append(n.Arrow[1].replace("#id#",
B.reTrim()))),$(w).css({left:arr_Right[a]-$(w).width()/2+C.left-x.scrollLeft(),top:z.offset().top-$(w).height()}).show(),$(B).css({left:arr_Right[a]-$(B).width()/2+C.left-x.scrollLeft(),top:z.offset().top+K}).show(),o=a);if(c<arr_Right[a]&&(a==0||c>arr_Right[a-1]))o=a,a==r?$(v).removeClass("ok"):$(v).addClass("ok"),c<arr_Middle[a]&&(o=a-1)});else{var c=b.offsetX||b.layerX,e=$(b.target),d=e.outerWidth();d-c<=a.gridCellDragTouchWidth&&c<=d&&e.parents(f.Head).length&&(L=d+e.get(0).offsetLeft,M=d,I=e.attr("class").match(/r\d+$/)[0],
$(l).css({left:$(b.target).position().left-1+c,width:"3px","background-color":"#000"}).show())}});b=a.firstCheckbox?$(f.Head).children(":not(:first)"):$(f.Head).children();$(b,c).bind({mousedown:function(b){b.button==2?(this.oncontextmenu=function(){return!1},a.callback&&a.callback.rightMouse&&a.callback.rightMouse.call(d,b,this)):(J=!0,E=m(),arr_Right=u(E),arr_Middle=i(E),z=$(this),r=$(f.Head,e).children(":not(:hidden)").index(z),$(window.document).bind({selectstart:D,mouseup:P}))}});d.setPageIcon=
function(b){$("[class^=first]",g).removeClass(b[0]==1?"first":"first_gray").addClass(b[0]==1?"first_gray":"first");$("[class^=prev]",g).removeClass(b[0]==1?"prev":"prev_gray").addClass(b[0]==1?"prev_gray":"prev");$("[class^=next]",g).removeClass(b[0]==b[1]?"next":"next_gray").addClass(b[0]==b[1]?"next_gray":"next");$("[class^=last]",g).removeClass(b[0]==b[1]?"last":"last_gray").addClass(b[0]==b[1]?"last_gray":"last");$(".input input",g).val(b[0]);$(".input i",g).text(b[1]);$(".other i",g).text(b[2]);
var c={};c.curPage=b[0];c.couPage=b[1];c.couData=b[2];a.Page.data=c};if(a.Page&&a.Page.isPage){b="#grid_page_"+q;$(e).append(n.Page.replace("#id#",b.reTrim()));var g=$(b);d.grid_Page=g;$(e).height($(e).height()+g.height());if(a.Page.Events){var j=a.Page.Events;j.First&&$("[class^=first]",g).click(function(){$(this).hasClass("first_gray")||t(j.First)});j.Prev&&$("[class^=prev]",g).click(function(){$(this).hasClass("prev_gray")||t(j.Prev)});j.Next&&$("[class^=next]",g).click(function(){$(this).hasClass("next_gray")||
t(j.Next)});j.Last&&$("[class^=last]",g).click(function(){$(this).hasClass("last_gray")||t(j.Last)});j.Fresh&&$(".reload",g).click(function(){t(j.Fresh)});j.Input&&$(".input input",g).bind({keydown:function(b){if(!/\d+/.test(String.fromCharCode(b.keyCode>=96?b.keyCode-48:b.keyCode))&&!/^(8|9|37|39|13|46)$/.test(b.keyCode))return!1;if(b.keyCode==13){if(!this.value.length)return this.focus(),!1;if(~~this.value<=0||~~this.value>a.Page.data.couPage)return this.select(),!1;t(j.Input)}}});var t=function(b){d.loading();
b.call(d,{curPage:$(".input input",g).val(),couPage:a.Page.data.couPage,couData:a.Page.data.couData,datPage:$(".visible select option:selected",g).val()},[$(".input input",g).val(),$(".visible select option:selected",g).val(),a.Page.data.couPage,a.Page.data.couData])},F=document.createElement("select"),G=a.Page.visible?a.Page.visible:[20,40,60];$.each(G,function(a){F.options.add(new Option(G[a],G[a]))});b=j.Visible?s.isArray(j.Visible)?j.Visible[0]:20:20;F.selectedIndex=s.indexOf(b,G);$(".visible",
g).append(F);j.Visible&&$(F).change(function(){t(s.isArray(j.Visible)?j.Visible[1]:j.Visible)});d.setPageIcon([a.Page.data==void 0?1:a.Page.data.curPage,a.Page.data==void 0?0:a.Page.data.couPage,a.Page.data==void 0?0:a.Page.data.couData])}}d.getChangeSource=function(b){var c=$(f.Head,e),d=[];a.firstCheckbox&&d.push('<span class="grid_col"><input type="checkbox" /></span>');c.children().each(function(c){if(a.firstCheckbox&&c==0)return!0;c=$(this).attr("class").match(/r\d+$/)[0];d.push(b.match(RegExp('<span[^"]+"(\\w|\\s)+'+
c+'"[^>]*>((?!<\\/span>).)*<\\/span>'))[0])});return d.join("")};a.DataSource&&d.updateView(a.DataSource)}var Q={tabName:"",DataSource:null,firstCheckbox:!1,gridCellDragTouchWidth:5,Templete:{view_Row:"",view_Cell:"",drag_Layer:"",layerTip:"",Arrow:null},callback:{titleSort:["i",["grid_menu_zx","grid_menu_dx"],function(){}],rightMouse:null,changeCheckbox:null},gridElement:{Head:"div.grid_tit",View:"div.grid_data_wrap div.grid_data_item",dataCenter:".grid_center"},Page:{isPage:!1,Tempelete:"",visible:[20,
40,60],Events:{First:null,Prev:null,Input:null,Next:null,Last:null,Fresh:null,Visible:null}}};s.augment(A,{updateView:function(c){var a=this,h=a.container,m=a.config,i=a.ele,u=a.temp,d=c&&c.data?c.data:[],b=$(i.viewContainer,h),f=u.viewRow,n=u.viewCell,p="",u=$(i.Head,h);$(i.Head,h).css("top","0px");$(i.dataCenter,h).scrollTop(0);m.Page&&m.Page.isPage&&a.setPageIcon([c.curPage,c.couPage,c.couData]);$.each(d,function(b,c){var d="";$.each(c,function(a,b){d+=n.replace("#cell#",b).replace("#cls#","r"+
a)});d=a.getChangeSource(d);p+=f.replace("#row#",d)});b.removeClass("load").html(p);b=$(i.View,h);m.firstCheckbox&&b.each(function(){$(this).children(":first").find("input[type=checkbox]").click(function(){m.callback&&m.callback.changeCheckbox&&m.callback.changeCheckbox.call(a,this)})});u.children(":hidden").each(function(){var a="."+$(this).attr("class").match(/r\d+$/)[0];b.children(a).hide()});a.config.DataSource=c;a.updateTabWidth()},wasHidden:function(c,a){var h=this.container,m=this.ele,i=$(m.Head,
h),h=$(m.View,h);a?$(i).children().filter(".r"+c).show():$(i).children().filter(".r"+c).hide();$.each(h,function(h,d){a?$(d).children().filter(".r"+c).show():$(d).children().filter(".r"+c).hide()});this.updateTabWidth()},loading:function(){var c=this.container,a=this.ele;$(a.viewContainer,c).addClass("load").html('<img alt="" src="'+BQ.Config.base+'/ui/static/loading.gif" /> <i></i>');$(a.Title,c).width($(c).innerWidth());$(a.dataCenter,c).children().first().width($(this.autoGrid).width())},orderBy:function(c){var a=
this;s.each(c,function(c,m){var i=s.indexOf(m,a.caption);a.config.DataSource.data.sort(function(a,d){return c?a[i]>d[i]?1:a[i]==d[i]?0:-1:a[i]<d[i]?1:a[i]==d[i]?0:-1})});a.updateView(a.config.DataSource)},setList:function(c){for(var a=$(".visible select",this.grid_Page).get(0),h=0;h<a.length;h++)a.options[h].value==c&&(a.selectedIndex=h)},autoGrid:this.autoGrid});return A});
